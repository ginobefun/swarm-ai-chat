# SwarmAI.chat 测试指南

## 📋 测试概览

本文档提供了在部署到生产环境之前需要完成的全面测试计划。测试分为多个关键领域，确保应用程序的稳定性和用户体验。

---

## 🎯 测试目标

- ✅ 验证所有核心功能正常工作
- ✅ 确保 UI/UX 流畅且响应式
- ✅ 测试错误处理和边界情况
- ✅ 验证性能优化的效果
- ✅ 确保数据一致性和安全性

---

## 📦 前置准备

### 1. 环境设置

```bash
# 1. 安装依赖
npm install

# 2. 生成 Prisma Client
npx prisma generate

# 3. 运行数据库迁移
npx prisma db push

# 4. 检查环境变量
cp .env.example .env.local
# 编辑 .env.local 并配置所有必需的变量

# 5. 启动开发服务器
npm run dev
```

### 2. 必需的环境变量

```env
# 数据库
DATABASE_URL="postgresql://..."

# 认证
BETTER_AUTH_SECRET="your-secret-key"
BETTER_AUTH_URL="http://localhost:3000"

# OpenRouter API
OPENROUTER_API_KEY="your-openrouter-key"
OPENROUTER_BASE_URL="https://openrouter.ai/api/v1"

# (可选) 其他配置
NODE_ENV="development"
```

---

## 🧪 功能测试场景

### 1. 用户认证与授权 (高优先级)

#### 1.1 用户注册
- [ ] 使用有效的电子邮件和密码注册新用户
- [ ] 验证密码强度要求
- [ ] 测试重复邮箱注册（应该失败）
- [ ] 验证用户名唯一性
- [ ] 检查注册成功后自动登录

**预期结果**：
- 注册成功后跳转到主页
- 用户信息正确保存到数据库
- Session 正确创建

**测试数据**：
```json
{
  "email": "test@example.com",
  "password": "SecurePass123!",
  "username": "testuser"
}
```

#### 1.2 用户登录
- [ ] 使用正确的凭证登录
- [ ] 使用错误的密码（应该失败）
- [ ] 使用不存在的邮箱（应该失败）
- [ ] 验证 "记住我" 功能
- [ ] 测试登录后的会话持久性

**预期结果**：
- 登录成功后显示用户信息
- 错误凭证显示清晰的错误消息
- Session 在页面刷新后保持

#### 1.3 用户登出
- [ ] 点击登出按钮
- [ ] 验证 session 被清除
- [ ] 确认重定向到登录页面

---

### 2. 会话管理 (高优先级)

#### 2.1 创建会话
- [ ] 点击 "新对话" 按钮
- [ ] 输入会话标题和描述
- [ ] 选择主要 Agent
- [ ] 选择会话类型（单人/群聊）
- [ ] 验证会话在侧边栏显示

**预期结果**：
- 新会话出现在会话列表顶部
- 会话详情正确保存
- 自动切换到新会话

**测试用例**：
```javascript
{
  title: "测试会话",
  description: "这是一个测试会话",
  type: "SINGLE",
  primaryAgentId: "gemini-flash"
}
```

#### 2.2 切换会话
- [ ] 从侧边栏选择不同的会话
- [ ] 验证消息历史正确加载
- [ ] 确认上下文切换正确

**预期结果**：
- 切换会话时正确加载历史消息
- 无闪烁或延迟
- 滚动位置正确（底部）

#### 2.3 编辑会话
- [ ] 点击会话的编辑按钮
- [ ] 修改标题和描述
- [ ] 保存更改
- [ ] 验证更改立即反映在 UI 中

#### 2.4 删除会话
- [ ] 点击删除按钮
- [ ] 确认删除对话框
- [ ] 验证会话从列表中移除
- [ ] 确认相关数据被删除

**注意**：确保删除是永久性的且不可恢复（或实现软删除）

#### 2.5 固定会话
- [ ] 点击固定图标
- [ ] 验证固定的会话置顶显示
- [ ] 取消固定后恢复原位置

---

### 3. 消息功能 (关键功能)

#### 3.1 发送消息
- [ ] 在输入框输入消息
- [ ] 点击发送或按 Enter 键
- [ ] 验证消息立即显示
- [ ] 确认 AI 响应流式显示

**测试消息**：
```
1. "你好，请介绍一下自己"
2. "帮我生成一个 Python 函数来计算斐波那契数列"
3. "创建一个 React 组件显示用户列表"
4. "用 Mermaid 图表展示软件架构"
```

**预期结果**：
- 用户消息右对齐，蓝色背景
- AI 消息左对齐，灰色背景
- 流式响应平滑显示
- 代码块正确高亮

#### 3.2 消息格式化
- [ ] 发送包含 Markdown 的消息
- [ ] 验证粗体、斜体、列表渲染
- [ ] 测试代码块语法高亮
- [ ] 检查链接是否可点击

**测试消息**：
```markdown
# 标题测试
## 二级标题

**粗体文本** 和 *斜体文本*

- 列表项 1
- 列表项 2

[链接测试](https://example.com)

代码测试：`const x = 10;`
```

#### 3.3 长消息处理
- [ ] 发送超长消息（>1000 字符）
- [ ] 验证滚动功能
- [ ] 测试消息虚拟化（VirtualizedMessageList）
- [ ] 发送 100+ 条消息，检查性能

**性能指标**：
- 100 条消息加载时间 < 1 秒
- 滚动流畅，无卡顿
- 内存使用合理

#### 3.4 @ 提及功能
- [ ] 输入 @ 符号
- [ ] 验证 Agent 列表弹出
- [ ] 选择一个 Agent
- [ ] 发送消息并验证 Agent 参与

**预期结果**：
- @ 下拉菜单正确显示
- 选中的 Agent 高亮显示
- 被提及的 Agent 会响应

---

### 4. Artifact 功能 (核心功能)

#### 4.1 代码 Artifact
- [ ] 请求 AI 生成代码
- [ ] 验证 Artifact 面板显示
- [ ] 检查语法高亮
- [ ] 测试复制代码按钮
- [ ] 验证多语言支持（Python, JavaScript, Java, etc.）

**测试提示**：
```
"生成一个 Python 函数来排序数组"
"创建一个 React 组件显示表格"
"写一个 SQL 查询来统计用户数量"
```

#### 4.2 Mermaid 图表 Artifact
- [ ] 请求 AI 生成流程图
- [ ] 验证 Mermaid 图表正确渲染
- [ ] 测试不同类型的图表（流程图、时序图、甘特图）
- [ ] 检查图表缩放和导出功能

**测试提示**：
```
"创建一个用户注册流程的流程图"
"绘制一个微服务架构的组件图"
```

#### 4.3 Chart Artifact
- [ ] 请求 AI 生成数据可视化
- [ ] 验证图表正确渲染
- [ ] 测试不同图表类型（折线图、柱状图、饼图）
- [ ] 检查交互功能（悬停、缩放）

**测试提示**：
```
"创建一个显示过去6个月销售数据的折线图"
"生成一个市场份额的饼图"
```

#### 4.4 Artifact 管理
- [ ] 固定/取消固定 Artifact
- [ ] 验证固定的 Artifact 置顶
- [ ] 测试 Artifact 版本历史按钮
- [ ] 关闭 Artifact 面板

---

### 5. 群聊功能 (高级功能)

#### 5.1 创建群聊
- [ ] 创建新的群聊会话
- [ ] 添加多个 Agent
- [ ] 发送消息
- [ ] 验证所有 Agent 参与讨论

**测试场景**：
```
Agents:
- Code Expert
- Data Scientist
- Article Summarizer

Message: "请设计一个数据分析系统的架构"
```

**预期结果**：
- 每个 Agent 提供专业领域的见解
- 响应按顺序或并行显示
- Agent 之间的讨论有逻辑连贯性

#### 5.2 编排模式
- [ ] 测试顺序模式（Sequential）
- [ ] 测试并行模式（Parallel）
- [ ] 测试动态模式（Dynamic）
- [ ] 比较不同模式的响应时间

**预期结果**：
- 顺序：Agent 按顺序响应
- 并行：多个 Agent 同时响应
- 动态：根据消息内容智能选择 Agent

#### 5.3 Agent 管理
- [ ] 在群聊中添加新 Agent
- [ ] 移除现有 Agent
- [ ] 查看 Agent 列表
- [ ] 修改 Agent 角色

---

### 6. 错误处理 (关键)

#### 6.1 网络错误
- [ ] 断开网络连接
- [ ] 发送消息
- [ ] 验证错误提示
- [ ] 恢复网络后重试

**预期结果**：
- 友好的错误消息
- 提供重试选项
- 不丢失用户输入

#### 6.2 API 错误
- [ ] 模拟 API 超时
- [ ] 模拟 API 500 错误
- [ ] 模拟速率限制

**预期结果**：
- ErrorBoundary 捕获错误
- 显示清晰的错误信息
- 应用不崩溃

#### 6.3 组件错误
- [ ] 触发组件渲染错误
- [ ] 验证 ErrorBoundary 显示
- [ ] 测试 "Try Again" 按钮

**预期结果**：
- 错误不传播到整个应用
- 用户可以恢复或重试
- 错误详情在开发环境中可见

---

### 7. 性能测试 (优化验证)

#### 7.1 消息虚拟化
- [ ] 加载 1000+ 条消息
- [ ] 测试滚动性能
- [ ] 验证内存使用

**性能指标**：
- 初始加载时间 < 2 秒
- 滚动帧率 > 30fps
- 内存增长 < 50MB

#### 7.2 上下文优化
- [ ] 发送长对话（50+ 轮）
- [ ] 验证 ContextManager 工作
- [ ] 检查控制台日志中的优化信息

**预期结果**：
```
Context optimized: 50 -> 15 messages, 3500 tokens
```

#### 7.3 API 速率限制
- [ ] 快速连续发送多条消息
- [ ] 验证请求排队
- [ ] 检查速率限制日志

**预期结果**：
- 请求不被拒绝
- 按顺序处理
- 无错误提示

---

### 8. UI/UX 测试 (用户体验)

#### 8.1 响应式设计
- [ ] 在移动设备上测试（< 768px）
- [ ] 在平板设备上测试（768px - 1024px）
- [ ] 在桌面上测试（> 1024px）

**测试点**：
- 侧边栏在移动端隐藏/展开
- Artifact 面板在移动端可切换
- 按钮和输入框大小合适
- 文字可读性

#### 8.2 深色模式
- [ ] 切换到深色模式
- [ ] 验证所有组件颜色适配
- [ ] 检查对比度和可读性
- [ ] 测试深浅模式切换流畅性

#### 8.3 加载状态
- [ ] 验证初始加载 spinner
- [ ] 检查消息加载动画
- [ ] 测试 Artifact 加载状态
- [ ] 验证 skeleton screens

#### 8.4 动画效果
- [ ] 测试消息淡入动画
- [ ] 检查 Artifact 展开动画
- [ ] 验证页面过渡效果
- [ ] 确保动画流畅（60fps）

---

### 9. 数据持久化 (数据安全)

#### 9.1 会话持久化
- [ ] 创建会话并发送消息
- [ ] 刷新页面
- [ ] 验证会话和消息保留

#### 9.2 用户设置
- [ ] 修改用户设置（主题、语言等）
- [ ] 刷新页面
- [ ] 验证设置保留

#### 9.3 离线支持（如果实现）
- [ ] 断网后继续使用
- [ ] 查看缓存的消息
- [ ] 恢复网络后同步

---

### 10. 安全测试 (安全性)

#### 10.1 XSS 防护
- [ ] 尝试注入 HTML 标签
- [ ] 尝试注入 JavaScript 代码
- [ ] 验证 SafeMarkdown 组件工作

**测试输入**：
```
<script>alert('XSS')</script>
<img src=x onerror=alert('XSS')>
[Click me](javascript:alert('XSS'))
```

**预期结果**：
- 所有脚本被转义或移除
- 不执行任何恶意代码

#### 10.2 CSRF 防护
- [ ] 验证请求包含 CSRF token
- [ ] 测试跨站请求被拒绝

#### 10.3 认证授权
- [ ] 未登录访问受保护页面
- [ ] 验证重定向到登录页
- [ ] 测试 token 过期处理

---

## 🔧 测试工具和技术

### 手动测试
- Chrome DevTools (网络、性能、控制台)
- React DevTools
- 不同浏览器（Chrome, Firefox, Safari, Edge）
- 不同设备（手机、平板、桌面）

### 自动化测试（可选）
```bash
# 运行单元测试
npm run test

# 运行端到端测试（如果配置）
npm run test:e2e

# 生成测试覆盖率报告
npm run test:coverage
```

---

## 📊 测试结果记录

### 测试模板

```markdown
## 测试执行记录

**日期**: 2025-XX-XX
**测试人**: [姓名]
**环境**: [开发/预发布/生产]

### 执行情况

| 测试场景 | 状态 | 备注 |
|---------|------|------|
| 用户注册 | ✅ | 正常 |
| 用户登录 | ✅ | 正常 |
| 创建会话 | ❌ | 标题长度限制问题 |
| 发送消息 | ✅ | 正常 |
| ... | ... | ... |

### 发现的问题

1. **[BUG-001] 会话标题过长时UI溢出**
   - 严重程度：中
   - 复现步骤：...
   - 预期结果：...
   - 实际结果：...

2. **[BUG-002] 深色模式下按钮文字不可见**
   - 严重程度：高
   - 复现步骤：...

### 性能指标

- 首屏加载时间：1.2s
- 消息发送响应时间：<500ms
- 100条消息滚动帧率：55fps
- 内存使用：平均 85MB

### 总体评估

✅ **可以发布**: 所有关键功能正常，无阻塞性bug
⚠️ **需要修复**: 存在影响用户体验的问题
❌ **不可发布**: 存在严重bug或功能缺失
```

---

## 🚀 发布前检查清单

### 代码质量
- [ ] 所有 TypeScript 错误已修复
- [ ] 所有 ESLint 警告已处理
- [ ] 代码已格式化（Prettier）
- [ ] 无 console.log（或已移除/条件化）
- [ ] 所有 TODO 注释已处理

### 性能
- [ ] Lighthouse 分数 > 90
- [ ] 首屏加载时间 < 3秒
- [ ] 图片已优化
- [ ] 代码已分割（Code Splitting）
- [ ] 启用生产构建优化

### 安全
- [ ] 环境变量已正确配置
- [ ] API keys 不在代码中
- [ ] XSS 防护已测试
- [ ] HTTPS 已启用（生产环境）
- [ ] 安全头已配置

### 数据库
- [ ] 迁移已应用
- [ ] 数据库备份已创建
- [ ] 索引已优化
- [ ] 连接池已配置

### 监控和日志
- [ ] 错误监控已配置（如 Sentry）
- [ ] 性能监控已启用
- [ ] 日志级别正确设置
- [ ] 关键操作已记录

---

## 📝 常见问题和解决方案

### Q1: Prisma generate 失败
```bash
# 解决方案
export PRISMA_ENGINES_CHECKSUM_IGNORE_MISSING=1
npx prisma generate
```

### Q2: Next.js 构建失败（字体问题）
```bash
# 临时解决：使用本地字体或跳过字体优化
# 在 next.config.js 中配置
```

### Q3: 消息不显示
检查：
1. Session 是否正确加载
2. API 端点是否正常响应
3. 浏览器控制台错误
4. 网络请求状态

### Q4: Agent 不响应
检查：
1. OpenRouter API key 是否有效
2. API 配额是否耗尽
3. 模型名称是否正确
4. 网络连接状态

---

## 📞 支持和反馈

如果在测试过程中遇到问题：

1. **检查日志**: 查看浏览器控制台和服务器日志
2. **重现问题**: 记录详细的复现步骤
3. **报告Bug**: 在 GitHub Issues 中创建详细的bug报告
4. **寻求帮助**: 联系开发团队

---

## 🎯 测试完成标准

测试被认为完成当：

✅ **关键功能**：所有核心功能正常工作（认证、会话、消息、Artifact）
✅ **性能达标**：性能指标达到预期
✅ **无阻塞Bug**：无影响使用的严重错误
✅ **跨浏览器兼容**：在主流浏览器中正常工作
✅ **响应式设计**：在各种设备上显示正常
✅ **安全性验证**：通过安全测试
✅ **文档完整**：所有测试结果已记录

---

**祝测试顺利！🎉**
